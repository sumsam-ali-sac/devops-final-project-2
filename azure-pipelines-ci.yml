trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: InstallAndBuild
  displayName: 'Install Dependencies and Build'
  steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
        checkLatest: true

    - script: |
        cd client
        npm install
        npm run build
      displayName: 'Install Client Dependencies and Build Frontend'

    - script: |
        npm install
      displayName: 'Install Backend Dependencies and Build Backend'

    - script: |
        wget https://github.com/mozilla/geckodriver/releases/download/v0.26.0/geckodriver-v0.26.0-linux64.tar.gz
        tar -xvzf geckodriver-v0.26.0-linux64.tar.gz
        chmod +x geckodriver
        sudo mv geckodriver /usr/local/bin/
      displayName: 'Install Geckodriver'

    - script: |
        sudo apt-get update
        sudo apt-get install -y firefox
      displayName: 'Install Firefox'

    - script: |
        npm start &
        while ! curl --output /dev/null --silent --head --fail http://localhost:5000; do
          printf '.'
          sleep 5
        done
      displayName: 'Start Backend Server and Check Readiness'

    - script: |
        cd client
        npm run dev &
        while ! curl --output /dev/null --silent --head --fail http://localhost:5173; do
          printf '.'
          sleep 5
        done
      displayName: 'Start Frontend Server and Check Readiness'

    - script: |
        cd client
        npm run test
      displayName: 'Run Selenium tests'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)/client/dist'
        ArtifactName: 'frontend'
        publishLocation: 'container'
      displayName: 'Publish Frontend Build Artifacts'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)/api/node/dist'
        ArtifactName: 'backend'
        publishLocation: 'container'
      displayName: 'Publish Backend Build Artifacts'
